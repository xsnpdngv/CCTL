#!/usr/bin/env bash
#
# Run analysis from the project dir where the
# CodeChecker configuration resides:
#
#  project/
#  ├── codechecker/
#  │   ├── config.yml
#  │   └── skipfile.txt
#  ├── compile_commands.json
#  └── src/
#
#  ${HOME}/
#  ├── .codechecker/
#  |   └── passwords.json 
#  └── .local/
#      └── share/
#          └── codechecker/
#              └── workspace/
#                  └── server_config.json

set -euo pipefail

CONTAINER_HOSTNAME="cctl"
IMAGE="cctl:ubuntu24.04"
WORKDIR="/work"
PROJECT_ROOT="$(pwd)" # "$(cd "$(dirname "$0")" && pwd)"
PROJECT_CCDIR="codechecker"
PROJECT_CONFIG="${PROJECT_CCDIR}/config.yml"
PROJECT_SKIPFILE="${PROJECT_CCDIR}/skipfile.txt"
PROJECT_REPORT_DIR="${PROJECT_CCDIR}/report"
PROJECT_REPORT_HTML_DIR="${PROJECT_CCDIR}/report-html"
PROJECT_COMPILE_DB="compile_commands.json"
PROJECT_BUILD_CMD="make force DEBUG=1"

DOCKER=${DOCKER:-docker}
DOCKER_NET="cctl-bridge" # makes possible the reach the server
                         # running in one container from another
                         # container, e.g., for storing analysis
                         # results

COMMON_OPTS=(
  --rm
  --hostname ${CONTAINER_HOSTNAME}
  -v "$PROJECT_ROOT:$WORKDIR"
  -v "$HOME/.codechecker/passwords.json:/root/.codechecker.passwords.json"
  -w "$WORKDIR"
)

NW_OPTS=(
  "${COMMON_OPTS[@]}"
  --network "${DOCKER_NET}"
)

BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "default" )"
CC_STORE_NAME="${BRANCH}"


run() {
  $DOCKER run "${COMMON_OPTS[@]}" "$IMAGE" "$@"
}

runit() {
  $DOCKER run "${COMMON_OPTS[@]}" -it "$IMAGE" "$@"
}

run_nw() {
  $DOCKER run "${NW_OPTS[@]}" "$IMAGE" "$@"
}

cc_opt_if_file_exists() {
  local opt="$1"
  local path="$2"

  if [ -f "$path" ]; then
    echo "$opt" "$path"
  fi
}


# -----------------------------
# CodeChecker server settings
# -----------------------------
SERVER_CONTAINER="codechecker-server"
SERVER_PORT=8001
SERVER_PRODUCT="inode6"

CC_DATA_BASE="${XDG_DATA_HOME:-$HOME/.local/share}/codechecker"
SERVER_WORKSPACE="$CC_DATA_BASE/workspace"

server_up() {
  mkdir -p "$SERVER_WORKSPACE"

  if $DOCKER ps -a --format '{{.Names}}' | grep -qx "$SERVER_CONTAINER"; then
    echo "CodeChecker server container already exists."
    echo "Use '$0 server-down' first if you want to restart it."
    exit 0
  fi

  if ! network_status "${DOCKER_NET}" >/dev/null; then
    echo -n "Creating inter-container bridge network..."
    $DOCKER network create "${DOCKER_NET}" >/dev/null \
      && echo DONE || echo FAILED
  fi

  echo -n "Starting CodeChecker server on port $SERVER_PORT..."
  $DOCKER run -d \
    --name "$SERVER_CONTAINER" \
    -p "$SERVER_PORT:8001" \
    -v "$SERVER_WORKSPACE:/workspace" \
    --network ${DOCKER_NET} \
    "$IMAGE" \
    CodeChecker server \
      --workspace /workspace \
      --host 0.0.0.0 \
      --port 8001 > /dev/null \
    && echo -e "DONE\nOpen http://localhost:$SERVER_PORT in your browser." \
    || echo FAILED
}

server_down() {
  if ! $DOCKER ps -a --format '{{.Names}}' | grep -qx "$SERVER_CONTAINER"; then
    echo "CodeChecker server is not running."
    exit 0
  fi

  echo -n "Stopping CodeChecker server..."
  $DOCKER stop "$SERVER_CONTAINER" >/dev/null &&
  $DOCKER rm "$SERVER_CONTAINER" >/dev/null \
  && echo "DONE" || echo "FAILED"

  echo -n "Removing inter-container bridge network..."
  $DOCKER network rm "${DOCKER_NET}" >/dev/null \
  && echo DONE || echo FAILED
}

server_status() {
  if $DOCKER ps --format '{{.Names}}' | grep -qx "$SERVER_CONTAINER"; then
    echo "Container '$SERVER_CONTAINER' is running."

    if ! network_status "$DOCKER_NET"; then
      return 1
    fi

    # Check container is attached to the network
    if $DOCKER inspect \
        -f '{{json .NetworkSettings.Networks}}' \
        "$SERVER_CONTAINER" | grep -q "\"$DOCKER_NET\""; then
      echo "Container is attached to inter-container bridge network."
    else
      echo "WARNING: Container is NOT attached to inter-container bridge network."
      return 1
    fi

    run_nw curl -sf "http://${SERVER_CONTAINER}:${SERVER_PORT}/" > /dev/null \
      && echo "Inter-container connectivity: OK" \
      || echo "Inter-container connectivity: FAILED"

  elif $DOCKER ps -a --format '{{.Names}}' | grep -qx "$SERVER_CONTAINER"; then
    echo "'$SERVER_CONTAINER' container exists but is stopped."
  else
    echo "'$SERVER_CONTAINER' container does not exist."
  fi
}

network_status() {
  local net="$1"

  if ! $DOCKER network inspect "$net" >/dev/null 2>&1; then
    echo "Docker network '$net' does NOT exist."
    echo "Create it with:"
    echo "  docker network create $net"
    return 1
  fi

  echo "Inter-container bridge network '$net' exists."
  return 0
}

case "${1:-}" in
  b|build)
    run CodeChecker log \
    --build "${PROJECT_BUILD_CMD}" \
    --output "${PROJECT_COMPILE_DB}"
    ;;
  a|analyze)
    shift
    run CodeChecker analyze \
      "${PROJECT_COMPILE_DB}" \
      $(cc_opt_if_file_exists --config "${PROJECT_CONFIG}") \
      $(cc_opt_if_file_exists --skip   "${PROJECT_SKIPFILE}") \
      --output "${PROJECT_REPORT_DIR}" \
      "$@"
    ;;
  p|parse)
    shift
    run CodeChecker parse \
      "${PROJECT_REPORT_DIR}" \
      --export html \
      --output "${PROJECT_REPORT_HTML_DIR}" \
      "$@"
    ;;
  s|store)
    run_nw CodeChecker store \
      "${PROJECT_REPORT_DIR}" \
      --trim-path-prefix "${WORKDIR}" \
      --name "${CC_STORE_NAME}" \
      --url http://${SERVER_CONTAINER}:${SERVER_PORT}/${SERVER_PRODUCT}
    ;;
  l|list)
    run CodeChecker analyzers
    ;;
  up|start|server-up)
    server_up
    ;;
  down|stop|server-down)
    server_down
    ;;
  stat*|server-status)
    server_status
    ;;
  sh|shell)
    runit bash
    ;;
  *)
    echo "Usage:"
    echo "  $0 b|build"
    echo "  $0 a|analyze [args]"
    echo "  $0 p|parse [args]"
    echo "  $0 s|store [args]"
    echo "  $0 l|list"
    echo "  $0 up|start|server-up"
    echo "  $0 down|stop|server-down"
    echo "  $0 status|server-status"
    echo "  $0 sh|shell"
    exit 1
    ;;
esac
